const MARGIN_MM=25,JPEG_QUALITY=.9,A4_WIDTH_MM=210,A4_HEIGHT_MM=297,PDF_MAX_MM=5080,A4_CONTENT_WIDTH_MM=160,A4_CONTENT_HEIGHT_MM=247,PX_PER_MM=96/25.4,DEFAULT_FILENAME="screencapture",CLOB_CHUNK_SIZE=3e4,ICON_BASE=apex_img_dir||"/i/",USE_PDFSHIFT_SANDBOX=!1,UT_CSS_URL="https://app.springsolutions.com/i/themes/theme_42/22.2/css/Core.min.css",FONT_APEX_CSS="https://app.springsolutions.com/i/libraries/font-apex/2.2.1/css/font-apex.min.css";var apexScreenCapture={parseBoolean(e){if("string"!=typeof e)return;const t=e.trim().toLowerCase();return"true"===t||"false"!==t&&void 0},clob2Array(e,t){const a=[];for(let r=0;r<e.length;r+=t)a.push(e.slice(r,r+t));return a},dataURI2base64:e=>e.substring(e.indexOf(",")+1),svg2canvas:function(e,t){try{var a,r;$(e).find("svg").each((function(){(a=document.createElement("canvas")).className="tempCanvas",$(this).attr("width",$(this).innerWidth()),$(this).attr("height",$(this).innerHeight()),r=(r=(new XMLSerializer).serializeToString(this)).replace(/xmlns=\"http:\/\/www\.w3\.org\/2000\/svg\"/,""),canvg(a,r),$(a).insertAfter(this),$(this).attr("class","tempHide"),$(this).hide()})),t()}catch(e){t()}},_pdfOnePage(e){const t=160/(e.width/PX_PER_MM),a=e.height/PX_PER_MM*t,r=new jsPDF("p","mm",[210,a+50]);return r.addImage(e.toDataURL("image/jpeg",.9),"JPEG",25,25,160,a,null,"FAST"),r},_pdfMultiPage(e){const t=new jsPDF("p","mm","a4"),a=160/e.width,r=Math.floor(247/a),n=Math.ceil(e.height/r);for(let i=0,o=0;i<n;i++,o+=r){i>0&&t.addPage();const n=Math.min(r,e.height-o),s=document.createElement("canvas");Object.assign(s,{width:e.width,height:n}),s.getContext("2d").drawImage(e,0,o,e.width,n,0,0,e.width,n),t.addImage(s.toDataURL("image/jpeg",.9),"JPEG",25,25,160,n*a,null,"FAST")}return t},_pdfOneA4Page(e){const t=new jsPDF("p","mm","a4"),a=t.internal.pageSize.getWidth()-50,r=t.internal.pageSize.getHeight()-50,n=e.width/e.height,i=n>a/r?a:r*n,o=i/n,s=(a-i)/2+25,c=(r-o)/2+25;return t.addImage(e.toDataURL("image/jpeg",.9),"JPEG",s,c,i,o,null,"FAST"),t},createPDF(e,t){const a=160/(e.width/e.height)+50;return"CONT_PAGE"===t&&a<=5080?apexScreenCapture._pdfOnePage(e):"MULTI_PAGE_A4"===t||a>5080?apexScreenCapture._pdfMultiPage(e):apexScreenCapture._pdfOneA4Page(e)},collectAPEXStyleSheets(){const e=`${Array.from(document.querySelectorAll('link[rel="stylesheet"]')).filter((e=>e.href.includes("/i/"))).map((e=>`<link rel="stylesheet" href="${e.href.split("?")[0]}">`)).join("\n")}\n<style>\n${Array.from(document.styleSheets).map((e=>{try{return Array.from(e.cssRules).map((e=>e.cssText)).join("\n")}catch(t){return console.error(e+": "+t),""}})).join("\n")}\n</style>`;return console.log(e),e},buildHtmlShell(e){const t=`\n      <!DOCTYPE html>\n      <html lang="en">\n        <head>\n          <meta charset="utf-8">\n          <title>APEX Capture</title>\n  \n          <base href="https://app.springsolutions.com/i/">\n          <link rel="stylesheet" href="${FONT_APEX_CSS}">\n          <link rel="stylesheet" href="${UT_CSS_URL}">\n  \n          <style>\n            ${Array.from(document.styleSheets).map((e=>{try{return Array.from(e.cssRules).map((e=>e.cssText)).join("\n")}catch(e){return""}})).join("\n")}\n          </style>\n        </head>\n        <body>\n          ${e}\n        </body>\n      </html>\n    `;return console.log(t),t},convertViaPdfShift(e,t,a,r,n,i){const o="Basic "+btoa("api:"+e);fetch("https://api.pdfshift.io/v3/convert/pdf",{method:"POST",headers:{"Content-Type":"application/json",Authorization:o},body:JSON.stringify({source:t,sandbox:false,margin:25,remove_blank:!0,format:"A4",landscape:"LANDSCAPE"===a,zoom:n})}).then((e=>{if(!e.ok)throw new Error(e.status);return e.blob()})).then((e=>{const t=URL.createObjectURL(e),a=Object.assign(document.createElement("a"),{href:t,download:r});document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(t),i()})).catch((e=>{console.error("pdfShift error",e),i()}))},getImage(e,t,a,r,n,i,o=(()=>{})){let s,c;if("application/pdf"===r?(s=apexScreenCapture.createPDF(t,i),c=s.output("datauristring")):c=t.toDataURL(r),"DIRECT_DOWNLOAD"===a){if(s)s.save(n);else{const e=Object.assign(document.createElement("a"),{href:c,download:n});document.body.appendChild(e),e.click(),e.remove()}return o()}if("NEW_TAB"===a)return s?window.open(s.output("bloburl"),"_blank"):window.open().document.write(`<img src="${c}" />`),o();const l=apexScreenCapture.dataURI2base64(c),p=apexScreenCapture.clob2Array(l,3e4);apex.server.plugin(e,{f01:p,x01:r},{dataType:"html",success:()=>{$("body").trigger("screencapture-saved-db"),o()},error:(e,t)=>{$("body").trigger("screencapture-error-db"),console.error("getImage apex.server.plugin error:",t),o()}})},doHtml2Canvas(e,t,a,r,n,i,o,s,c,l,p,d){const h=apex.util.showSpinner($("body")).attr("data-html2canvas-ignore","true");apexScreenCapture.svg2canvas("body",(()=>{html2canvas($(e),{background:r,width:n,height:i,letterRendering:o,allowTaint:s,useCORS:!0,logging:l,onrendered:e=>{apexScreenCapture.getImage(a,e,t,c,p,d,(()=>h.remove()))}}),$("body").find(".asc-temp-canvas").remove(),$("body").find(".asc-temp-hide").show().removeClass("asc-temp-hide")}))},captureScreen(){const e=this.action,t=e.attribute01,a=e.attribute02,r=e.attribute04,n=e.attribute05,i=e.attribute06,o=apexScreenCapture.parseBoolean(e.attribute07),s=apexScreenCapture.parseBoolean(e.attribute08),c=apexScreenCapture.parseBoolean(e.attribute09),l=e.attribute10,p=e.attribute11,d=e.attribute12,h=e.attribute13,u=e.attribute14,m=e.attribute15,g="PNG"===m?"image/png":"JPEG"===m?"image/jpeg":"PDF"===m?"application/pdf":"image/png",f=("string"==typeof u&&u.trim().length?u.trim():"screencapture").replace(/[\\/:*?"<>|]/g,"_")+("PDFSHIFT"===a?".pdf":"PDF"===m?".pdf":"JPEG"===m?".jpg":".png");let S,b;if("body"!==t?(S=$(t).innerWidth(),b=$(t).innerHeight()):(S=document.documentElement.clientWidth,b=document.documentElement.clientHeight),n&&(S=parseInt(n,10)),i&&(b=parseInt(i,10)),c&&console.table({jQuerySelector:t,downloadType:a,backgroundColor:r,elemWidthPx:S,elemHeightPx:b,doLetterRendering:o,doAllowTaint:s,mimeType:g,fileName:u,sanitizedFileName:f,pdfLayout:l,pdfOrientation:d,pdfShiftZoom:h}),$(t).find(".t-Report-links").attr("data-html2canvas-ignore","true"),$(t).find(".u-Report-sortIcon").attr("data-html2canvas-ignore","true"),$(t).find(".a-Icon").attr("data-html2canvas-ignore","true"),$(t).find(".a-IRR-toolbar").attr("data-html2canvas-ignore","true"),$(t).find(".a-IRR-controlsContainer").attr("data-html2canvas-ignore","true"),"PDFSHIFT"!==a)apexScreenCapture.doHtml2Canvas(t,a,e.ajaxIdentifier,r,S,b,o,s,g,c,f,l);else{const e=apex.util.showSpinner($("body")).attr("data-html2canvas-ignore","true"),a=$(t).clone(!0,!0).find("[data-html2canvas-ignore]").remove().end().prop("outerHTML"),r=apexScreenCapture.buildHtmlShell($(a).prop("outerHTML"));apexScreenCapture.convertViaPdfShift(p,r,l,f,h,(()=>e.remove()))}}};